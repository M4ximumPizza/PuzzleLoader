import com.github.jengelman.gradle.plugins.shadow.tasks.ShadowJar

plugins {
    id("maven-publish")
    id("java")
    id("java-library")
    id("com.github.johnrengelman.shadow") version("8.1.1")
//    id "puzzle_gradle" version "1.0.2-dev"
}

group = "dev.crmodders"

repositories {
    mavenCentral()

    maven { url 'https://jitpack.io' }
    maven { url "https://maven.google.com/" }
    maven { url "https://maven.crmodders.dev/releases" }
    maven { url "https://maven.crmodders.dev/snapshots" }
    maven { url "https://maven.fabricmc.net/" }

    ivy {
        name "Cosmic Reach"
        url "https://cosmic-archive.netlify.app/"
        patternLayout {
            artifact "/Cosmic Reach-[revision].jar"
        }
        // This is required in Gradle 6.0+ as metadata file (ivy.xml) is mandatory
        metadataSources {
            artifact()
        }

        content {
            includeGroup "finalforeach"
        }
    }
}

dependencies {
    // Mixin
    compileOnly("net.fabricmc:sponge-mixin:$fabricMixinVersion+mixin.$baseMixinVersion")
    implementation(annotationProcessor("io.github.llamalad7:mixinextras-common:$mixinExtrasVersion"))

    // FluxAPI
    implementation("dev.crmodders:fluxapi:$fluxApiVersion")

    // Asm
    compileOnly("org.ow2.asm:asm:$asmVersion")
    compileOnly("org.ow2.asm:asm-tree:$asmVersion")
    compileOnly("org.ow2.asm:asm-util:$asmVersion")
    compileOnly("org.ow2.asm:asm-analysis:$asmVersion")
    compileOnly("org.ow2.asm:asm-commons:$asmVersion")

    // Log4j
    implementation("org.apache.logging.log4j:log4j-api:$log4jVersion")
    implementation("org.apache.logging.log4j:log4j-core:$log4jVersion")
    implementation("org.apache.logging.log4j:log4j-slf4j2-impl:$log4jVersion")

    // Jopt Simple
    implementation("net.sf.jopt-simple:jopt-simple:$joptSimpleVersion")

    // Reflections
    implementation("org.reflections:reflections:$reflectionsVersion")

////     Jython
//    implementation("org.python:jython-slim:2.7.3")
//
////     Lua J
//    implementation("party.iroiro.luajava:luajit:$luaJVersion")
//    implementation("party.iroiro.luajava:luajit-platform:$luaJVersion:natives-desktop")

    // Cosmic Reach
    compileOnly("finalforeach:cosmicreach:$cosmicReachVersion")
}

//puzzle_loader {
//    accessWidenerPath = file("src/main/resources/accesswidener/puzzle.accesswidener")
//}

tasks.register("runLoader", JavaExec) {
    group = "loader"

    dependencies {
        // Mixin
        runtimeOnly("net.fabricmc:sponge-mixin:$fabricMixinVersion+mixin.$baseMixinVersion")

        implementation(annotationProcessor("io.github.llamalad7:mixinextras-common:$mixinExtrasVersion"))

        // Asm
        compileOnly("org.ow2.asm:asm:$asmVersion")
        compileOnly("org.ow2.asm:asm-tree:$asmVersion")
        compileOnly("org.ow2.asm:asm-util:$asmVersion")
        compileOnly("org.ow2.asm:asm-analysis:$asmVersion")
        compileOnly("org.ow2.asm:asm-commons:$asmVersion")

        // Log4j
        implementation("org.apache.logging.log4j:log4j-api:$log4jVersion")
        implementation("org.apache.logging.log4j:log4j-core:$log4jVersion")
        implementation("org.apache.logging.log4j:log4j-slf4j2-impl:$log4jVersion")

        // Sl4j
        implementation("org.slf4j:slf4j-api:$slf4jVersion")

        // Jopt Simple
        implementation("net.sf.jopt-simple:jopt-simple:$joptSimpleVersion")

        // Reflections
        implementation("org.reflections:reflections:$reflectionsVersion")

        // Event Bus
        implementation("org.greenrobot:eventbus:$eventbusVersion")

        // Cosmic Reach
        runtimeOnly("finalforeach:cosmicreach:$cosmicReachVersion")
    }

    classpath = sourceSets.main.runtimeClasspath
    mainClass = "dev.crmodders.puzzle.core.launch.Piece"
}

shadowJar {
    manifest {
        attributes(
                "Main-Class": "dev.crmodders.puzzle.core.launch.Piece"
        )
    }
}

// Maven
tasks.register("buildJars") {
    group = "loader"

    dependsOn("buildFatJar")
    dependsOn("buildSourcesJar")
}

tasks.register("buildFatJar", ShadowJar) {
    group = "loader"

    manifest {
        attributes(
                "Main-Class": "dev.crmodders.puzzle.core.launch.Piece"
        )
    }

    dependsOn("compileJava")
    dependsOn("processResources")

    from(processResources.destinationDir)
    from(sourceSets.main.runtimeClasspath)
    from(sourceSets.main.output)

    mergeServiceFiles()

    archiveFileName = "${id}-${version}-fat.jar"
}

tasks.register("buildSourcesJar", Jar) {
    group = "loader"

    from(sourceSets.main.allSource)
    archiveFileName = "${id}-${version}-sources.jar"
}

publishing {
    repositories {
        maven {
            name = "crmReleases"
            url = "https://maven.crmodders.dev/releases"
            credentials{
                username = System.getenv("CRMReleasesUsername")
                password = System.getenv("CRMReleasesPassword")
            }
            authentication {
                basic(BasicAuthentication)
            }
        }
    }
    assemble.dependsOn buildSourcesJar, buildFatJar
    publications {
        maven(MavenPublication) {
            groupId = group
            artifactId = id

            artifact buildFatJar
            artifact source: buildSourcesJar, classifier: 'source', extension: 'jar'
        }
    }
}
